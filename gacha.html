<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>꽝 없는 뽑기 기계</title>
    <style>
        @font-face {
            font-family: 'GangwonEducationModuche';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2201-2@1.0/GangwonEdu_OTFLightA.woff') format('woff');
            font-weight: 300;
            font-display: swap;
        }

        @font-face {
            font-family: 'GangwonEducationModuche';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2201-2@1.0/GangwonEdu_OTFBoldA.woff') format('woff');
            font-weight: 700;
            font-display: swap;
        }
        
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'GangwonEducationModuche', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .gacha-container {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-image: url('https://github.com/jungsan21-dot/v480/blob/111ee436c24c12faf10e665e2530e7d6d7142e22/images/gachaback.png?raw=true');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .controls {
            position: absolute;
            bottom: 10%;
            width: 100%;
            height: 80px; 
        }

        .gacha-button {
            font-family: 'GangwonEducationModuche', sans-serif;
            font-weight: 700;
            color: #fff;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all .2s;
            box-shadow: 0 6px 8px rgba(0, 0, 0, .2);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            position: absolute;
        }
        .gacha-button:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 12px rgba(0, 0, 0, .3);
        }
        .gacha-button:disabled {
            background-color: #9ca3af !important;
            cursor: not-allowed;
            box-shadow: none;
        }

        #gacha-button { 
            background-color: #d9534f;
            padding: 2vh 5vw;
            font-size: clamp(3em, 7vh, 4em);
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
        }
        
        #edit-prizes-button { 
            background-color: #f0ad4e;
            padding: 1vh 2vw;
            font-size: clamp(0.8em, 1.8vh, 1em);
            right: 30px;
            bottom: 0;
        }

        #gacha-ball {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: clamp(180px, 36vmin, 360px); 
            height: clamp(180px, 36vmin, 360px);
            border-radius: 50%;
            box-shadow: 0 8px 20px rgba(0, 0, 0, .3);
            display: none;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-weight: 700;
            padding: 20px;
            box-sizing: border-box;
            cursor: pointer;
            z-index: 100;
            border: 6px solid #A52A2A;
            flex-direction: column;
        }
        
        .prize-icon {
            font-size: clamp(1.5em, 6vmin, 3em);
            line-height: 1;
        }
        
        #gacha-ball p {
            margin: 10px 0;
            font-size: clamp(1.32em, 5.5vmin, 2.75em); 
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            word-break: keep-all;
        }

        @keyframes fall-and-reveal {
            0% { top: 20%; transform: translate(-50%, -50%) scale(.1); opacity: 0; }
            50% { top: 60%; transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { top: 50%; transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .animate-ball {
            animation-name: fall-and-reveal;
            animation-timing-function: cubic-bezier(0.68, -0.55, 0.27, 1.55);
            animation-fill-mode: forwards;
        }

        @keyframes fadeInContent {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        .prize-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation-name: fadeInContent;
            animation-timing-function: ease-out;
            animation-fill-mode: forwards;
        }

        #edit-prizes-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, .6); z-index: 2000; justify-content: center; align-items: center; }
        #edit-prizes-modal .modal-content { background: #fff; padding: 25px; border-radius: 15px; width: 90%; max-width: 600px; text-align: left; max-height: 85vh; display: flex; flex-direction: column; }
        #edit-prizes-modal h2 { margin-top: 0; }
        #prize-list { overflow-y: auto; flex-grow: 1; border: 1px solid #ccc; border-radius: 8px; margin: 10px 0; }
        .prize-item { display: flex; gap: 10px; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .prize-item input { padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; font-family: 'GangwonEducationModuche', sans-serif; }
        .prize-item input[type=text] { flex-grow: 1; }
        .prize-item input[type=number] { width: 80px; text-align: center; }
        .delete-prize-btn { background-color: #e53e3e; color: #fff; border: none; border-radius: 50%; width: 30px; height: 30px; font-weight: 700; cursor: pointer; flex-shrink: 0; }
        .modal-buttons { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-buttons button { padding: 10px 20px; border-radius: 8px; border: none; color: #fff; cursor: pointer; font-weight: bold; font-family: 'GangwonEducationModuche', sans-serif;}
    </style>
</head>
<body>
    <div class="gacha-container">
        <div class="controls">
            <button id="gacha-button" class="gacha-button">뽑기!</button>
            <button id="edit-prizes-button" class="gacha-button">선물 편집</button>
        </div>
        <div id="gacha-ball"></div>
    </div>

    <div id="edit-prizes-modal">
        <div class="modal-content">
            <h2>선물 목록 편집</h2>
            <div id="prize-list"></div>
            <div class="modal-buttons">
                <button id="add-prize-button" style="background-color:#3182ce">선물 추가</button>
                <button id="save-prizes-button" style="background-color:#5cb85c">저장</button>
                <button id="close-prizes-modal-button" style="background-color:#aaa">닫기</button>
            </div>
        </div>
    </div>
    <script>
        let items = [];
        const defaultItems = [
            { name: '빼빼로', quantity: 5 }, { name: '비쵸비 2개', quantity: 5 }, 
            { name: '새콤달콤', quantity: 5 }, { name: '카피바라 키링', quantity: 5 }, 
            { name: '고오급 샤프', quantity: 5 }, { name: '고오급 볼펜', quantity: 5 }, { name: '아무거나', quantity: 7 }
        ];
        const ballColors = ['#ff5662', '#ffb833', '#40b5a7', '#3d6170', '#c0f2f4'];
        
        const sounds = {
            buttonPress: new Audio('https://cdn.pixabay.com/audio/2025/05/31/audio_2895d0eabb.mp3'),
            ballRolling: new Audio('https://cdn.pixabay.com/audio/2024/07/30/audio_65c652a871.mp3'),
            prizeReveal: new Audio('https://cdn.pixabay.com/audio/2024/11/24/audio_caf639ccd1.mp3')
        };

        let soundDurations = { ballRolling: 5000, prizeReveal: 3500 };



        const ball = document.getElementById('gacha-ball');
        const button = document.getElementById('gacha-button');
        const editPrizesModal = document.getElementById('edit-prizes-modal');
        const prizeListContainer = document.getElementById('prize-list');
        let isAnimating = false;

        function getContrastColor(hex) {
            if (!hex) return 'black';
            hex = hex.replace('#', '');
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? 'black' : 'white';
        }

        function loadItems() {
            const savedItems = localStorage.getItem('gachaItems');
            items = savedItems ? JSON.parse(savedItems) : JSON.parse(JSON.stringify(defaultItems));
        }

        function saveItems() {
            localStorage.setItem('gachaItems', JSON.stringify(items));
        }

        function checkGachaAvailability() {
            const totalQuantity = items.reduce((sum, item) => sum + (item.quantity || 0), 0);
            button.disabled = totalQuantity === 0;
            button.textContent = totalQuantity === 0 ? '선물 없음' : '뽑기!';
        }

        async function drawItem() {
            if (isAnimating || items.reduce((sum, item) => sum + item.quantity, 0) === 0) return;
            isAnimating = true;
            button.disabled = true;

            // 1. 버튼 클릭 효과음 재생
            sounds.buttonPress.currentTime = 0;
            sounds.buttonPress.play();

            // ✨ 2초 지연을 추가합니다.
            setTimeout(() => {
                const prizePool = [];
                items.forEach(item => { for (let i = 0; i < item.quantity; i++) { prizePool.push(item.name); } });
                if (prizePool.length === 0) { isAnimating = false; checkGachaAvailability(); return; }
                const selectedItemName = prizePool[Math.floor(Math.random() * prizePool.length)];
                const selectedItem = items.find(item => item.name === selectedItemName);
                
                ball.style.backgroundColor = ballColors[Math.floor(Math.random() * ballColors.length)];
                ball.innerHTML = '';
                ball.style.display = 'flex';
                ball.classList.remove('animate-ball');
                void ball.offsetWidth;

                ball.style.animationDuration = `${soundDurations.ballRolling / 1000}s`;
                ball.classList.add('animate-ball');
                sounds.ballRolling.currentTime = 0;
                sounds.ballRolling.play();

                setTimeout(() => {
                    if (selectedItem) {
                        selectedItem.quantity--;
                        saveItems();
                    }
                    
                    sounds.prizeReveal.currentTime = 0;
                    sounds.prizeReveal.play();

                    ball.innerHTML = `<div class="prize-content" style="animation-duration: ${soundDurations.prizeReveal / 1000}s">
                                        <span class="prize-icon">🎁</span>
                                        <p>${selectedItemName}</p>
                                        <span class="prize-icon">🎉</span>
                                     </div>`;
                    
                    const textColor = getContrastColor(ball.style.backgroundColor);
                    ball.querySelector('.prize-content').style.color = textColor;

                    setTimeout(() => {
                        isAnimating = false;
                        checkGachaAvailability();
                    }, soundDurations.prizeReveal);

                }, soundDurations.ballRolling);

            }, 2000); // 2000ms = 2초
        }
        
        function renderPrizeEditor() {
            prizeListContainer.innerHTML = '';
            items.forEach((item, index) => {
                addPrizeRow(item, index);
            });
        }
        
        function addPrizeRow(item = { name: '', quantity: 1 }, index = -1) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'prize-item';
            itemDiv.innerHTML = `
                <input type="text" class="prize-name" value="${item.name}" placeholder="선물 이름">
                <input type="number" class="prize-quantity" value="${item.quantity}" min="0" placeholder="수량">
                <button class="delete-prize-btn">X</button>
            `;
            prizeListContainer.appendChild(itemDiv);
            
            itemDiv.querySelector('.delete-prize-btn').addEventListener('click', (e) => {
                e.target.closest('.prize-item').remove();
            });
        }
        
        document.getElementById('edit-prizes-button').addEventListener('click', () => {
            renderPrizeEditor();
            editPrizesModal.style.display = 'flex';
        });

        document.getElementById('add-prize-button').addEventListener('click', () => {
            addPrizeRow();
        });

        document.getElementById('save-prizes-button').addEventListener('click', () => {
            const newItems = [];
            prizeListContainer.querySelectorAll('.prize-item').forEach(el => {
                const name = el.querySelector('.prize-name').value.trim();
                const quantity = parseInt(el.querySelector('.prize-quantity').value, 10);
                if (name && !isNaN(quantity)) {
                    newItems.push({ name, quantity });
                }
            });
            
            if (newItems.length > 0) {
                items = newItems;
                saveItems();
                alert('선물 목록이 저장되었습니다!');
                editPrizesModal.style.display = 'none';
                checkGachaAvailability();
            } else {
                alert('유효한 선물이 하나 이상 있어야 합니다.');
            }
        });

        document.getElementById('close-prizes-modal-button').addEventListener('click', () => {
            editPrizesModal.style.display = 'none';
        });

        button.addEventListener('click', drawItem);
        ball.addEventListener('click', () => {
            if (!isAnimating) {
                ball.style.display = 'none';
            }
        });

        loadItems();
        checkGachaAvailability();
    </script>
</body>
</html>


